"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n),Object.defineProperty(e,o,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=__importDefault(require("path")),url_1=__importDefault(require("url")),electron_1=require("electron"),electron_is_dev_1=__importDefault(require("electron-is-dev")),electron_next_1=__importDefault(require("electron-next")),fs_1=require("fs"),promises_1=require("fs/promises"),execute=e=>{log(getDatetime()),log("::: @bizhermit/nextron :::"+(electron_is_dev_1.default?" [dev]":"")),log("# props"),log(e),electron_1.app.on("ready",(async()=>{const t=e?.dev?.port??8e3,n=e?.rootDirname??path_1.default.join(__dirname,"../../../../");await(0,electron_next_1.default)(path_1.default.join(n,"src"),t);const o=e?.width??1280,i=e?.height??720,a=electron_1.screen.getPrimaryDisplay().workAreaSize;let s,r;if("string"==typeof e?.position)switch(e?.position){case"left-top":s=0,r=0;break;case"right-bottom":s=a.width-o,r=a.height-i}else s=e?.position?.x,r=e?.position?.y;const l=new electron_1.BrowserWindow({width:o,height:i,minWidth:e?.minWidth??0,minHeight:e?.minHeight??0,maxWidth:e?.maxWidth,maxHeight:e?.maxHeight,resizable:e?.resizable??!0,useContentSize:e?.useContentSize??!1,fullscreen:e?.fullscreen??!1,fullscreenable:e?.fullscreenable??!0,maximizable:e?.maximizable??!0,minimizable:e?.minimizable??!0,closable:e?.closable??!0,x:s,y:r,movable:e?.movable??!0,opacity:e?.opacity??1,focusable:e?.focusable??!0,alwaysOnTop:e?.alwaysOnTop??!1,skipTaskbar:e?.skipTaskbar??!1,title:e?.title,frame:e?.frame??!0,hasShadow:e?.hasShadow??!0,icon:path_1.default.join(n,"src/public/favicon.ico"),webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:path_1.default.join(__dirname,"preload.js")}});await initializeMainProcess(n,l,e);let u="";electron_is_dev_1.default?(log("# listen"),u=`http://localhost:${t}/`,!1===e?.dev?.menubar&&l.setMenu(null),!1!==e?.dev?.openDevTools&&l.webContents.openDevTools()):(log("# boot"),e?.openDevTools&&l.webContents.openDevTools(),!0!==e?.menubar&&l.setMenu(null),u=url_1.default.format({pathname:path_1.default.join(n,"src/out/index.html"),protocol:"file:",slashes:!0})),l.loadURL(u),log(`start: ${u}`),log(getDatetime())})),electron_1.app.on("window-all-closed",electron_1.app.quit)};exports.default=execute;const log=(e,...t)=>{console.log(e,...t)},getDatetime=()=>{const e=e=>`00${e}`.slice(-2),t=new Date;return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}:${e(t.getSeconds())}.${`000${t.getMilliseconds()}`.slice(-3)}`},initializeMainProcess=async(e,t,n)=>{const o=global;o._session={};const i=electron_is_dev_1.default?path_1.default.join(e,"resources"):path_1.default.join(e,"../../resources");(0,fs_1.existsSync)(i)||await(0,promises_1.mkdir)(i,{recursive:!0});const a=path_1.default.join(i,"config.json");let s={};const r=async()=>await(0,promises_1.writeFile)(a,JSON.stringify(s,null,2),{encoding:"utf-8"});(0,fs_1.existsSync)(a)?s=await(async()=>JSON.parse(await(0,promises_1.readFile)(a,{encoding:"utf-8"})))():(s=n?.defaultConfig??{},await r()),o._session.layoutColor=s.layout?.color??n?.layoutColor??(electron_1.nativeTheme.shouldUseDarkColors?"dark":"light"),o._session.layoutDesign=s.layout?.design??n?.layoutDesign??"material",log("# i18n");let l="";l=electron_is_dev_1.default?n?.dev?.i18nFilename??path_1.default.join(e,"src/i18n"):n?.i18nFilename??path_1.default.join(e,"../i18n");try{o._language=(await Promise.resolve().then((()=>__importStar(require(l)))))?.default??{},log(l)}catch{o._language={},log(`Cannot find module: ${l}`)}o.nextron={};const u=(e,t,n)=>{"handle"===t&&(o.nextron[e]=(...e)=>n({},...e),electron_1.ipcMain.handle(e,n)),"on"===t&&(o.nextron[e]=(...e)=>{const t={};return n(t,...e),t.returnValue},electron_1.ipcMain.on(e,n))};u("fetch","handle",((t,n,i)=>new Promise(((t,a)=>{try{let s={};const r={statusCode:0,status:e=>(r.statusCode=e??0,r),json:e=>(s=e,r)},l=()=>{0===r.statusCode?setTimeout((()=>{l()}),5):t(s)};o._session.regenerate=e=>{Object.keys(o._session).forEach((e=>{"regenerate"!==e&&delete o._session[e]})),e?.()};const u={body:i,session:o._session,query:{},cookies:{}};let c=n,_=n.indexOf("?");if(_>=0){c=n.substring(0,_);n.substring(_+1).split("&").forEach((e=>{_=e.indexOf("=");const t=e.substring(0,_),n=_>=0?e.substring(_+1):"";if(t in u.query){const e=u.query[t];"string"==typeof e?u.query[t]=[e,n]:e.push(n)}else u.query[t]=n}))}Promise.resolve().then((()=>__importStar(require(path_1.default.join(e,"main/src/pages",c))))).then((e=>{try{e.default(u,r),l()}catch(e){a(e)}})).catch((e=>{a(e)}))}catch(e){a(e)}})))),u("setSize","on",((e,n)=>{try{const o=t.getSize();t.setSize(n.width??o[0],n.height??o[1],n.animate),e.returnValue=!0}catch{e.returnValue=!1}}));const c=()=>{const e=t.getSize();return{width:e[0],height:e[1]}};u("getSize","on",(e=>{e.returnValue=c()})),u("setAlwaysOnTop","on",((e,n)=>{t.setAlwaysOnTop(e.returnValue=n??!1)})),u("isAlwaysOnTop","on",(e=>{e.returnValue=t.isAlwaysOnTop()})),u("minimize","on",(e=>{t.minimize(),e.returnValue=c()})),u("unminimize","on",(e=>{t.restore(),e.returnValue=c()})),u("isMinimize","on",(e=>{e.returnValue=t.isMinimized()})),u("maximize","on",(e=>{t.maximize(),e.returnValue=c()})),u("unmaximize","on",(e=>{t.unmaximize(),e.returnValue=c()})),u("isMaximize","on",(e=>{e.returnValue=t.isMaximized()})),u("setFullScreen","on",((e,n)=>{t.setFullScreen(e.returnValue=n??!1)})),u("isFullScreen","on",(e=>{e.returnValue=t.isFullScreen()})),u("setOpacity","on",((e,n)=>{t.setOpacity(e.returnValue=n??1)})),u("getOpacity","on",(e=>{e.returnValue=t.getOpacity()}));u("setPosition","on",((e,n)=>{switch(n.position){case"center":t.center();break;case"left-top":t.setPosition(0,0,n.animate);break;case"right-bottom":const e=c(),o=electron_1.screen.getPrimaryDisplay().workAreaSize;t.setPosition(o.width-e.width,o.height-e.height,n.animate);break;default:const i=t.getPosition();t.setPosition(n.position.x??i[0],n.position.y??i[1],n.animate)}e.returnValue=(()=>{const e=t.getPosition();return{x:e[0],y:e[1]}})()})),u("close","on",(e=>{t.close(),e.returnValue=null})),u("destory","on",(e=>{t.destroy(),e.returnValue=null})),u("focus","on",(e=>{t.focus(),e.returnValue=null})),u("blur","on",(e=>{t.blur(),e.returnValue=null})),u("hasFocus","on",(e=>{e.returnValue=t.isFocused()})),u("notification","on",((e,t,n)=>new Notification(t,n))),u("setLayoutColor","handle",(async(e,t)=>(null==s.layout&&(s.layout={}),o._session.layoutColor=s.layout.color=electron_1.nativeTheme.themeSource=t||(electron_1.nativeTheme.shouldUseDarkColors?"dark":"light"),await r(),s.layout.color))),u("getLayoutColor","on",(e=>{e.returnValue=o._session.layoutColor})),u("setLayoutDesign","handle",(async(e,t)=>(null==s.layout&&(s.layout={}),o._session.layoutDesign=s.layout.design=t||"",await r(),s.layout.design))),u("getLayoutDesign","on",(e=>{e.returnValue=o._session.layoutDesign})),u("saveConfig","handle",(async(e,t)=>{s={...s,...t},await r()})),u("getConfig","on",((e,t)=>{null==t||0===t.length?e.returnValue=s:e.returnValue=s[t]})),u("getSession","on",((e,t)=>{e.returnValue=null==t?o._session:o._session[t]})),u("setSession","on",((e,t,n)=>{null!=t&&(o._session[t]=n),e.returnValue=n})),u("clearSession","on",((e,t)=>{null!=t&&delete o._session[t],e.returnValue=null})),u("getLanguage","on",((e,t)=>{e.returnValue=o._language[t??"ja"]??o._language})),u("test","on",(e=>{e.returnValue=0}))};