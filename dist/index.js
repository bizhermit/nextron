"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&__createBinding(t,e,n);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const path_1=__importDefault(require("path")),url_1=__importDefault(require("url")),electron_1=require("electron"),electron_is_dev_1=__importDefault(require("electron-is-dev")),electron_next_1=__importDefault(require("electron-next")),electron_store_1=__importDefault(require("electron-store")),execute=e=>{log(getDatetime()),log("::: @bizhermit/nextron :::"+(electron_is_dev_1.default?" [dev]":"")),log("# config"),log(e),electron_1.app.on("ready",(async()=>{const t=e?.dev?.port??8e3,n=e?.rootDirname??path_1.default.join(__dirname,"../../../../");await(0,electron_next_1.default)(path_1.default.join(n,"src"),t);const i=e?.width??1280,o=e?.height??720,r=electron_1.screen.getPrimaryDisplay().workAreaSize;let a,l;if("string"==typeof e?.position)switch(e?.position){case"left-top":a=0,l=0;break;case"right-bottom":a=r.width-i,l=r.height-o}else a=e?.position?.x,l=e?.position?.y;const s=new electron_1.BrowserWindow({width:i,height:o,minWidth:e?.minWidth??0,minHeight:e?.minHeight??0,maxWidth:e?.maxWidth,maxHeight:e?.maxHeight,resizable:e?.resizable??!0,useContentSize:e?.useContentSize??!1,fullscreen:e?.fullscreen??!1,fullscreenable:e?.fullscreenable??!0,maximizable:e?.maximizable??!0,minimizable:e?.minimizable??!0,closable:e?.closable??!0,x:a,y:l,movable:e?.movable??!0,opacity:e?.opacity??1,focusable:e?.focusable??!0,alwaysOnTop:e?.alwaysOnTop??!1,skipTaskbar:e?.skipTaskbar??!1,title:e?.title,frame:e?.frame??!0,hasShadow:e?.hasShadow??!0,icon:path_1.default.join(n,"src/public/favicon.ico"),webPreferences:{nodeIntegration:!1,contextIsolation:!0,preload:path_1.default.join(__dirname,"preload.js")}});await initializeMainProcess(n,s,e);let c="";electron_is_dev_1.default?(log("# listen"),c=`http://localhost:${t}/`,!1===e?.dev?.menubar&&s.setMenu(null),!1!==e?.dev?.openDevTools&&s.webContents.openDevTools()):(log("# boot"),e?.openDevTools&&s.webContents.openDevTools(),!0!==e?.menubar&&s.setMenu(null),c=url_1.default.format({pathname:path_1.default.join(n,"src/out/index.html"),protocol:"file:",slashes:!0})),s.loadURL(c),log(`start: ${c}`),log(getDatetime())})),electron_1.app.on("window-all-closed",electron_1.app.quit)};exports.default=execute;const log=(e,...t)=>{console.log(e,...t)},getDatetime=()=>{const e=e=>`00${e}`.slice(-2),t=new Date;return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}:${e(t.getSeconds())}.${`000${t.getMilliseconds()}`.slice(-3)}`},initializeMainProcess=async(e,t,n)=>{const i=global;i._session={};const o=new electron_store_1.default;o.set("theme",i._session.theme=o.get("theme")??n?.theme??(electron_1.nativeTheme.shouldUseDarkColors?"dark":"light")),log("# i18n");let r="";r=electron_is_dev_1.default?n?.dev?.i18nFilename??path_1.default.join(e,"src/i18n"):n?.i18nFilename??path_1.default.join(e,"../i18n");try{i._language=(await Promise.resolve().then((()=>__importStar(require(r)))))?.default??{},log(r)}catch{i._language={},log(`Cannot find module: ${r}`)}electron_1.ipcMain.handle("fetch",((t,n,o)=>new Promise(((t,r)=>{try{let a={};const l={statusCode:0,status:e=>(l.statusCode=e??0,l),json:e=>(a=e,l)},s=()=>{0===l.statusCode?setTimeout((()=>{s()}),5):t(a)};i._session.regenerate=e=>{Object.keys(i._session).forEach((e=>{"regenerate"!==e&&delete i._session[e]})),e?.()};const c={body:o,session:i._session,query:{},cookies:{}};let u=n,_=n.indexOf("?");if(_>=0){u=n.substring(0,_);n.substring(_+1).split("&").forEach((e=>{_=e.indexOf("=");const t=e.substring(0,_),n=_>=0?e.substring(_+1):"";if(t in c.query){const e=c.query[t];"string"==typeof e?c.query[t]=[e,n]:e.push(n)}else c.query[t]=n}))}Promise.resolve().then((()=>__importStar(require(path_1.default.join(e,"main/src/pages",u))))).then((e=>{try{e.default(c,l),s()}catch(e){r(e)}})).catch((e=>{r(e)}))}catch(e){r(e)}})))),electron_1.ipcMain.on("setSize",((e,n)=>{try{const i=t.getSize();t.setSize(n.width??i[0],n.height??i[1],n.animate),e.returnValue=!0}catch{e.returnValue=!1}}));const a=()=>{const e=t.getSize();return{width:e[0],height:e[1]}};electron_1.ipcMain.on("getSize",(e=>{e.returnValue=a()})),electron_1.ipcMain.on("setAlwaysOnTop",((e,n)=>{t.setAlwaysOnTop(e.returnValue=n??!1)})),electron_1.ipcMain.on("isAlwaysOnTop",(e=>{e.returnValue=t.isAlwaysOnTop()})),electron_1.ipcMain.on("minimize",(e=>{t.minimize(),e.returnValue=a()})),electron_1.ipcMain.on("unminimize",(e=>{t.restore(),e.returnValue=a()})),electron_1.ipcMain.on("isMinimize",(e=>{e.returnValue=t.isMinimized()})),electron_1.ipcMain.on("maximize",(e=>{t.maximize(),e.returnValue=a()})),electron_1.ipcMain.on("unmaximize",(e=>{t.unmaximize(),e.returnValue=a()})),electron_1.ipcMain.on("isMaximize",(e=>{e.returnValue=t.isMaximized()})),electron_1.ipcMain.on("setFullScreen",((e,n)=>{t.setFullScreen(e.returnValue=n??!1)})),electron_1.ipcMain.on("isFullScreen",(e=>{e.returnValue=t.isFullScreen()})),electron_1.ipcMain.on("setOpacity",((e,n)=>{t.setOpacity(e.returnValue=n??1)})),electron_1.ipcMain.on("getOpacity",(e=>{e.returnValue=t.getOpacity()}));electron_1.ipcMain.on("setPosition",((e,n)=>{switch(n.position){case"center":t.center();break;case"left-top":t.setPosition(0,0,n.animate);break;case"right-bottom":const e=a(),i=electron_1.screen.getPrimaryDisplay().workAreaSize;t.setPosition(i.width-e.width,i.height-e.height,n.animate);break;default:const o=t.getPosition();t.setPosition(n.position.x??o[0],n.position.y??o[1],n.animate)}e.returnValue=(()=>{const e=t.getPosition();return{x:e[0],y:e[1]}})()})),electron_1.ipcMain.on("close",(e=>{t.close(),e.returnValue=null})),electron_1.ipcMain.on("destory",(e=>{t.destroy(),e.returnValue=null})),electron_1.ipcMain.on("focus",(e=>{t.focus(),e.returnValue=null})),electron_1.ipcMain.on("blur",(e=>{t.blur(),e.returnValue=null})),electron_1.ipcMain.on("hasFocus",(e=>{e.returnValue=t.isFocused()})),electron_1.ipcMain.handle("notification",((e,t,n)=>new Notification(t,n))),electron_1.ipcMain.on("setTheme",((e,t)=>{o.set("theme",e.returnValue=i._session.theme=electron_1.nativeTheme.themeSource=t??(electron_1.nativeTheme.shouldUseDarkColors?"dark":"light"))})),electron_1.ipcMain.on("getTheme",(e=>{e.returnValue=i._session.theme})),electron_1.ipcMain.on("getSession",((e,t)=>{e.returnValue=null==t?i._session:i._session[t]})),electron_1.ipcMain.on("setSession",((e,t,n)=>{null!=t&&(i._session[t]=n),e.returnValue=n})),electron_1.ipcMain.on("clearSession",((e,t)=>{null!=t&&delete i._session[t],e.returnValue=null})),electron_1.ipcMain.on("getLanguage",((e,t)=>{e.returnValue=i._language[t??"ja"]??i._language})),electron_1.ipcMain.on("test",(e=>{e.returnValue=0}))};